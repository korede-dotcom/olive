<%- include ("./partials/header.ejs") %>

    <section class="largeImg">
        <div class="swiper">
            <!-- Additional required wrapper -->
            <div class="swiper-wrapper">
                <!-- Slides -->
                <div class="swiper-slide">
                    <img src="/assest/OLIVE/woman.png" />
                </div>
                <div class="swiper-slide">
                    <img style="height: 452px; width: 414px;object-fit: cover;" src="/assest/OLIVE/guy.png" />
                </div>

                <div class="swiper-slide">
                    <img src="/assest/OLIVE/ankara.png" />
                </div>

                <div class="swiper-slide">
                    <img src="/assest/OLIVE/flowergirl.png" />
                </div>

            </div>
            <!-- If we need pagination -->
            <div class="swiper-pagination"></div>

            <!-- If we need navigation buttons -->

            <div class="swiper-button-prev">
                <img class="carousel-l" src="/assest/OLIVE/Group 2.png" />
            </div>
            <div class="swiper-button-next">
                <img class="carousel" src="/assest/OLIVE/Group 2.png" />
            </div>

            <!-- If we need scrollbar -->
            <div class="swiper-scrollbar"></div>

            <!-- 
            <img src="/assest/OLIVE/guy.png" />
            <img src="/assest/OLIVE/woman.png" />  -->
        </div>
        <!--  -->
    </section>
    <section class="content">

        <h4 class="content_header">Auditions Available</h4>

        <div class="boxs">
            <% if (auditions) { %>

                <% auditions.forEach(element=> { %>

                    <div class="bo" style="position: relative; cursor: pointer;">

                        <img width="147px" height="147px" style="border-radius:12px" src=<%=element.auditionLogo %>>

                        <h6 class="content_header audition" data-id="<%=element._id %>"
                            data-provider="<%=element.provider %>">
                            <%= element.auditionName %>
                        </h6>
                        <% if(element.auditionPrice> 0){ %>
                            <p class="content_header audition" hidden>
                                &#x20A6; <span>
                                    <%= element.auditionPrice %>
                                </span>
                            </p>
                            <div class="detect" style="position: relative; bottom: 67px; right: -56px;">
                                <img src="/assest/OLIVE/Rectangle 43.png" alt="" srcset="">
                                <small style="position: absolute;right: 60px;top: 2px; color: #DF465E
                                ;font-size: smaller;">Paid</small>
                            </div>

                            <!-- <button type="button" onClick="makePayment()">Pay Now</button> -->
                            <% } else { %>
                                <p class="content_header audition" hidden>
                                    <span>
                                        <%= element.auditionPrice - element.auditionPrice %>
                                    </span>
                                </p>
                                <div class="detect" style="position: relative; bottom: 67px; right: -56px;">
                                    <img src="/assest/OLIVE/Rectangle 43.png" alt="" srcset="">
                                    <small
                                        style="position: absolute;right: 60px;top: 2px;color: #DF465E;font-size: smaller;">Free</small>
                                </div>
                                <% } %>
                    </div>


                    <% }) %>
                        <% } %>
        </div>




    </section>

    <div class="">
        <div class="footer_social">
            <div>
                <p>&copy; 2021 GhenGhen Live</p>
            </div>
            <div class="social_icon">
                <img src="/assest/OLIVE/fb.png" />
                <img src="/assest/OLIVE/instagram.png" />
                <img src="/assest/OLIVE/twitter.png" />
            </div>
        </div>
    </div>
    <script src="https://checkout.flutterwave.com/v3.js"></script>
    <script>
        const user_id = "<%= user._id %>"
        const auditions = document.querySelectorAll(".bo");
        auditions.forEach(element => {
            element.addEventListener("click", (e) => {
                const parent = e.target.parentElement;
                console.log(parent)
                const id = parent.querySelector('.audition').getAttribute("data-id");
                const provider = parent.querySelector('.audition').getAttribute("data-provider");
                const logo = parent.querySelector('img').getAttribute("src");
                const price = parent.querySelector('span').innerHTML;


                fetch("/check", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        id: id,
                    })
                }).then(res => res.json())
                    .then(data => {
                        console.log(data);
                        if (data.status === "paid") {
                            function makePayment() {

                                FlutterwaveCheckout({
                                    public_key: "FLWPUBK_TEST-ee16b8429467881fb5912f6e31e72a52-X",
                                    tx_ref: `${id}${Date.now()}`,
                                    amount: price,
                                    currency: "NGN",
                                    country: "NG",
                                    payment_options: " ",
                                    // redirect_url: // specified redirect URL
                                    //     `http://localhost:1200/paidaudition?audition=${id}&provider=${provider}&user=${user_id}`,
                                    meta: {
                                        consumer_id: 23,
                                        consumer_mac: "92a3-912ba-1192a",
                                    },
                                    customer: {
                                        email: "<%=user.email%>",
                                        phone_number: "<%= user.username %>",
                                        name: "GhenGhen Live tution",
                                    },
                                    callback: function (datas) {
                                        fetch("/paid", {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json",
                                            },
                                            body: JSON.stringify({
                                                data: datas,
                                                user: '<%=user._id%>',
                                                audition: id,


                                            })
                                        }).then(res => res.json())
                                            .then(data => {
                                                console.log(data);
                                                if (data.status) {
                                                    window.location.assign(`
                                                        /paidaudition?audition=${id}&provider=${provider}&user=${user_id}&txref=${datas.tx_ref}`
                                                    );
                                                } else {
                                                    window.location.assign("/digitalauditionplatform")
                                                }
                                            })
                                    },
                                    onclose: function () {
                                        window.location.assign("/digitalauditionplatform")
                                    },
                                    customizations: {
                                        title: "GhenGhen Live",
                                        description: "GhenGhen Live tution for <%=auditions.auditionName%>",
                                        logo: logo,
                                    },
                                });
                            }

                            makePayment()
                        }
                        else {
                            // post all details to the server
                            fetch("/free", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    user: '<%=user._id%>',
                                    audition: id,
                                })
                            }).then(res => res.json())
                                .then(data => {
                                    console.log(data);
                                    if (data.status) {
                                        window.location.assign(`
                                        /digitalauditionplatform/${data.status}`
                                        );
                                    } else {
                                        window.location.assign("/digitalauditionplatform")
                                    }
                                })
                        }
                    })





            });
        });



        // const API_publicKey = "<ADD YOUR PUBLIC KEY HERE>";

        // function payWithRave() {
        //     var x = getpaidSetup({
        //         PBFPubKey: API_publicKey,
        //         customer_email: "user@example.com",
        //         amount: 2000,
        //         customer_phone: "234099940409",
        //         currency: "NGN",
        //         txref: "rave-123456",
        //         meta: [{
        //             metaname: "flightID",
        //             metavalue: "AP1234"
        //         }],
        //         onclose: function () { },
        //         callback: function (response) {
        //             var txref = response.data.txRef; // collect txRef returned and pass to a                    server page to complete status check.
        //             console.log("This is the response returned after a charge", response);
        //             if (
        //                 response.data.chargeResponseCode == "00" ||
        //                 response.data.chargeResponseCode == "0"
        //             ) {
        //                 // redirect to a success page
        //             } else {
        //                 // redirect to a failure page.
        //             }

        //             x.close(); // use this to close the modal immediately after payment.
        //         }
        //     });
        // }
    </script>
    <%- include("./partials/footer.ejs") %>